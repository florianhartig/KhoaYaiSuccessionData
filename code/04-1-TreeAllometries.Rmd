---
title: "Supplementary - TreeAllometries"
author: ""
date: "5 Aug 2014"
output: html_document
---

# Preparing workspace

```{r message =FALSE}
rm(list=ls(all=TRUE))
source("01-packages.R", print.eval =F)
load(file = "../data/cleanedData.RData")
attach(cleanedData)
stageNames = c("Establishment", "Exclusion", "Old-growth")

colorMap <- function(value){
  colors = c("black", "chartreuse4", "darkorange")
  return(colors[value])
}
```


## Session info for full reproducibility

Returns the random seed and the version number of all packages

```{r message =FALSE}
.Random.seed
sessionInfo() 
```

# Diameter - height 

```{r}
fitTH <- lmer(log10(TH) ~ log10(Dbh_a) * Stage + I(log10(Dbh_a)^2) + (1|Plot)) 
summary(fitTH)
anova(fitTH)
cleanedData$predictedTreeHeight<- predict(fitTH, newdata = cleanedData)

plot1 <- function(){
  plot(log10(Dbh_a), log10(TH), pch = as.numeric(Stage), xlim = c(0.5, 2), main = "Tree height")
  mtext("A", side = 2, adj=4, las=1, padj=-11, cex = 2)
  points(log10(Dbh_a), cleanedData$predictedTreeHeight, col = colorMap(Stage), cex = 0.2)
  legend("bottomright", legend = stageNames, pch = 1:3, col = colorMap(1:3), lwd = 1)
  

}
plot1()
```

#  Diameter - crown area

```{r}

fitCA <- lmer(log10(crownArea) ~ log10(Dbh_a) * Stage + I(log10(Dbh_a)^2) + (1|Plot)) 
summary(fitCA)
anova(fitCA)
cleanedData$predictedCrownArea<- predict(fitCA, newdata = cleanedData)

plot2 <- function(){
  plot(log10(Dbh_a), log10(crownArea), pch = as.numeric(Stage), xlim = c(0.5, 2), main = "Crown projection area")
  mtext("B", side = 2, adj=4, las=1, padj=-11, cex = 2)
  points(log10(Dbh_a), cleanedData$predictedCrownArea, col = colorMap(Stage), cex = 0.2)
  legend("bottomright", legend = stageNames, pch = 1:3, col = colorMap(1:3), lwd = 1)
  

}
plot2()
```

#  Diameter - crown height

```{r}


fitCH <- lmer(log10(crownHeight) ~ log10(Dbh_a) * Stage + I(log10(Dbh_a)^2) + (1|Plot)) 
summary(fitCH)
anova(fitCH)
cleanedData$predictedCrownHeight<- predict(fitCH, newdata = cleanedData)

plot3 <- function(){
  plot(log10(Dbh_a), log10(crownHeight), pch = as.numeric(Stage), xlim = c(0.5, 2), main = "Crown height")
 mtext("C", side = 2, adj=4, las=1, padj=-11, cex = 2)
  points(log10(Dbh_a), cleanedData$predictedCrownHeight, col = colorMap(Stage), cex = 0.2)
  legend("bottomright", legend = stageNames, pch = 1:3, col = colorMap(1:3), lwd = 1)
}
plot3()
```

#  Diameter - crown volume

```{r}


fitCV <- lmer(log10(crownVolume) ~ log10(Dbh_a) * Stage + I(log10(Dbh_a)^2) + (1|Plot)) 
summary(fitCV)
anova(fitCV)
cleanedData$predictedCrownVolume<- predict(fitCV, newdata = cleanedData)

plot4 <- function(){
  plot(log10(Dbh_a), log10(crownVolume), pch = as.numeric(Stage), xlim = c(0.5, 2), main = "Crown Volume")
  mtext("D", side = 2, adj=4, las=1, padj=-11, cex = 2)
  points(log10(Dbh_a), cleanedData$predictedCrownVolume, col = colorMap(Stage), cex = 0.2)
  legend("bottomright", legend = stageNames, pch = 1:3, col = colorMap(1:3), lwd = 1)
}
plot4()
```

# cleaning up

```{r}

png("../results/paper/Allometries.png", width = 1000, height = 1000)
par(mfrow = c(2,2), cex = 1.3)
plot1()
plot2()
plot3()
plot4()
dev.off()
detach(cleanedData)


results.allometrie <- data.frame(fixef(fitTH), sqrt(diag(vcov(fitTH))), 
                                 fixef(fitCA), sqrt(diag(vcov(fitCA))), 
                                 fixef(fitCH), sqrt(diag(vcov(fitCH))),
                                 fixef(fitCV), sqrt(diag(vcov(fitCV))) )

colnames(results.allometrie) = c("Dia-Hei", "SE.H" ,"Dia-CA", "SE.CA" ,
                                 "Dia-CH", "SE.CH" ,"Dia-CV", "SE.CV" )


save.image(file = "../data/cleanedData2.RData")


```

x <- cbind(log10(Dbh_a), log10(TH), log10(crownHeight), log10(crownVolume), Stage )
x <- x[(is.na(x[,4]) == F), ]
pr.cmp <- princomp(x)
summary(pr.cmp)
biplot(pr.cmp)

summary(lm(log10(Dbh_a[!is.na(TH)]) ~ Stage[!is.na(TH)]))


